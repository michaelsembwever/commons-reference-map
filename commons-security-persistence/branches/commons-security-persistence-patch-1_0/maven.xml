<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->

<project 
	xmlns:ant="jelly:ant"
        xmlns:j="jelly:core"
        xmlns:m="jelly:maven"
        xmlns:u="jelly:util"
        default="jar">

    <postGoal
            name="test:prepare-filesystem">
        <mkdir dir="${maven.build.dir}/test-logs"/>
    </postGoal>

    <preGoal
            name="xdoclet:hibernatedoclet">

        <mkdir dir="${maven.xdoclet.hibernatedoclet.destDir}"/>
    </preGoal>

    <postGoal
            name="xdoclet:hibernatedoclet">

        <copy todir="${maven.build.dest}">
            <fileset dir="${maven.xdoclet.hibernatedoclet.destDir}"/>
        </copy>
    </postGoal>

    <preGoal
            name="java:compile">

        <attainGoal name="xdoclet:hibernatedoclet"/>
    </preGoal>

    <preGoal
            name="test:test-resources">

        <copy todir="${maven.test.dest}">
            <fileset dir="${maven.xdoclet.hibernatedoclet.destDir}"/>
        </copy>
    </preGoal>

    <preGoal name="test:compile">
        <mkdir dir="${maven.build.dir}/gen-src"/>

        <path
                id="project.extra.src.set"
                location="${maven.build.dir}/gen-src"/>
        <m:addPath
                id="maven.compile.src.set"
                refid="project.extra.src.set"/>

        <!-- Generate mockobjects -->
        <ant:taskdef name="mockmaker" classname="mockmaker.AntTask">
            <ant:classpath>
                <ant:pathelement location="${plugin.getDependencyPath('mockmaker:mockmaker')}"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
        </ant:taskdef>
        <mockmaker srcdir="${maven.src.dir}" destdir="${maven.build.dir}/gen-src"/>
        <attainGoal name="java:compile"/>
    </preGoal>

    <goal name="source"
          description="Generate zip containing source java files.">
        <attainGoal name="java:prepare-filesystem"/>
        <j:set var="source.zip" value="${maven.build.dir}/${maven.final.name}.zip"/>
        <delete file="${source.zip}"/>
        <ant:zip zipfile="${source.zip}">
            <ant:zipfileset dir="${maven.src.dir}" includes="**/*.java"/>
        </ant:zip>
    </goal>

    <goal name="source:install"
          description="Install source zip in repository.">
        <attainGoal name="source"/>
        <j:set var="source.zip" value="${maven.build.dir}/${maven.final.name}.zip"/>
        <copy todir="${maven.repo.local}/${pom.groupId}/src" file="${source.zip}"/>
    </goal>

    <goal name="jboss:deploy"
          description="Deploys artifact to JBoss">
        <attainGoal name="sar"/>
        <copy todir="${maven.jboss.home}/${maven.jboss.deploy.dir}" file="${maven.build.dir}/${maven.sar.final.name}"/>
    </goal>
    
    <preGoal name="jar:install">
	    	<attainGoal name="source:install"/>
    </preGoal>

   <!-- Multiproject Goal -->
    <goal name="admin:build">
	<attainGoal name="jboss:deploy" />
    </goal>
</project>
