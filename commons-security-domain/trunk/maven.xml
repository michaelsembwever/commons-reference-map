<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->


<project
    xmlns:ant="jelly:ant"
    xmlns:j="jelly:core"
    xmlns:m="jelly:maven"
    xmlns:u="jelly:util"
    default="jar">

    <postGoal
        name="test:prepare-filesystem">
        <mkdir dir="${maven.build.dir}/test-logs"/>
    </postGoal>

    <preGoal name="test:compile">
        <mkdir dir="${maven.build.dir}/generated-sources/java"/>

        <path
            id="project.extra.src.set"
            location="${maven.build.dir}/generated-sources/java"/>
        <m:addPath
            id="maven.compile.src.set"
            refid="project.extra.src.set"/>

        <!-- Generate mockobjects -->
        <ant:taskdef name="mockmaker" classname="mockmaker.AntTask">
            <ant:classpath>
                <ant:pathelement location="${plugin.getDependencyPath('mockmaker:mockmaker')}"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
        </ant:taskdef>
        <mockmaker srcdir="${maven.src.dir}" destdir="${maven.build.dir}/generated-sources/java"/>
        <attainGoal name="java:compile"/>
    </preGoal>

    <postGoal name="test:compile">
        <ant:path id="aop.classpath">
            <ant:pathelement location="${plugin.getDependencyPath('jboss:jboss-aop')}"/>
            <ant:path refid="maven.dependency.classpath"/>
            <pathelement path="target/classes"/>
            <pathelement path="target/test-classes"/>
        </ant:path>

        <ant:taskdef name="aopc" classname="org.jboss.aop.ant.AopC" classpathref="aop.classpath"/>
        <!--ant:aopc compilerclasspathref="aop.classpath" classpathref="aop.classpath" verbose="true">
            <ant:classpath refid="aop.classpath"/>
            <ant:src path="target/classes;target/test-classes"/>
            <ant:aoppath path="src/test/conf/jboss-aop.xml"/>
        </ant:aopc-->
    </postGoal>

    <goal name="jboss:deploy"
        description="Deploys artifact to JBoss">
        <attainGoal name="jar"/>
        <copy todir="${maven.jboss.home}/${maven.jboss.deploy.dir}" file="${maven.build.dir}/${maven.final.name}.jar"/>
    </goal>
    
    <goal name="source"
        description="Generate zip containing source java files.">
        <attainGoal name="java:prepare-filesystem"/>
        <j:set var="source.zip" value="${maven.build.dir}/${maven.final.name}.zip"/>
        <delete file="${source.zip}"/>
        <ant:zip zipfile="${source.zip}">
            <ant:zipfileset dir="${maven.src.dir}" includes="**/*.java"/>
        </ant:zip>
    </goal>

    <goal name="source:install"
        description="Install source zip in repository.">
        <attainGoal name="source"/>
        <j:set var="source.zip" value="${maven.build.dir}/${maven.final.name}.zip"/>
        <copy todir="${maven.repo.local}/${pom.groupId}/src" file="${source.zip}"/>
    </goal>
    
    <preGoal name="jar:install">
	    	<attainGoal name="source:install"/>
    	</preGoal>

    <!-- Multiproject Goal -->
    <goal name="admin:build">
	<attainGoal name="jboss:deploy" />
   </goal>

</project>
